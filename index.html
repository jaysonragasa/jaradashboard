<!-- 

MIT License

Copyright (c) 2025 Jayson Ragasa

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Widgets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the dashboard and widgets */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            touch-action: none; /* Prevent default touch actions like scrolling when dragging */
            background-image: linear-gradient(
                rgba(0, 0, 0, 0.3),
                rgba(0, 0, 0, 0.0)), 
                url('https://images.pexels.com/photos/212324/pexels-photo-212324.jpeg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            transition: background 0.5s ease-in-out;
        }

        body.bg-hidden {
            background-image: none !important;
            background-color: #111827;
        }

        .widget {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(9px);
            -webkit-backdrop-filter: blur(9px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.5),
                inset 0 -1px 0 rgba(255, 255, 255, 0.1),
                inset 0 0 14px 7px rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out, width 0.3s ease-in-out, height 0.3s ease-in-out;
            z-index: 10;
            overflow: hidden;
            min-width: 280px; /* Prevent widgets from becoming too small */
            min-height: 200px;
            padding-bottom: 50px;
        }
        
        .widget::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.8),
                transparent
            );
        }

        .widget::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 1px;
            height: 100%;
            background: linear-gradient(
                180deg,
                rgba(255, 255, 255, 0.8),
                transparent,
                rgba(255, 255, 255, 0.3)
            );
        }
        
        .dark .widget {
            background: rgba(17, 24, 39, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .widget-header {
            cursor: move;
            user-select: none;
        }
        
        .widget.dragging, .widget.resizing {
            transform: scale(1.02);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transition: none;
        }

        .widget.minimized { 
            width: 64px !important; /* Use !important to override inline styles */
            height: 64px !important; 
            min-width: 64px; /* Override the min-width */
            min-height: 64px; /* Override the min-height */
            overflow: hidden; 
            resize: none; /* Disable resizing when minimized */
        }
        .widget.minimized .widget-content, .widget.minimized .widget-header .title-text, .widget.minimized .resize-gripper { display: none; }
        .widget.minimized .widget-header .icon-container { margin: 0; }
        
        .resize-gripper {
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            cursor: se-resize;
            z-index: 20;
            opacity: 0.3;
            transition: opacity 0.2s;
        }
        .widget:hover .resize-gripper {
            opacity: 0.8;
        }

        .clock-face { width: 150px; height: 150px; border: 2px solid rgba(255, 255, 255, 0.5); border-radius: 50%; position: relative; }
        .hand { width: 50%; position: absolute; top: 50%; transform-origin: 100%; transform: rotate(90deg); transition: transform 0.05s cubic-bezier(0.4, 2.08, 0.55, 0.44); }
        .hour-hand { height: 4px; background: #ffffff; width: 30%; left: 20%; }
        .minute-hand { height: 3px; background: #ffffff; width: 40%; left: 10%; }
        .second-hand { height: 1px; background: #ef4444; width: 45%; left: 5%; }
        .clock-center { width: 8px; height: 8px; background: #ffffff; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100; }

        .todo-item { cursor: pointer; }
        .todo-item.completed span { text-decoration: line-through; color: #d1d5db; }
        .delete-btn { visibility: hidden; opacity: 0; transition: opacity 0.2s ease-in-out; }
        .todo-item:hover .delete-btn { visibility: visible; opacity: 1; }
        .todo-item.dragging { opacity: 0.5; }

        .day-cell { position: relative; }
        .event-indicator { position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); width: 5px; height: 5px; background-color: #ef4444; border-radius: 50%; }
        .day-cell.selected { background-color: rgba(59, 130, 246, 0.5); }
        .day-cell.today { border: 1px solid rgba(255, 255, 255, 0.8); }
        #event-modal, #context-menu-container { display: none; }

        /* Weather Animations */
        .weather-animation-bg { position: absolute; inset: 0; z-index: 0; }
        .sun { position: absolute; top: 30%; left: 50%; width: 60px; height: 60px; background: #facc15; border-radius: 50%; transform: translate(-50%, -50%); }
        .weather-sunny .sun { animation: spin 20s linear infinite; }
        .cloud { position: absolute; background: #e5e7eb; border-radius: 30px; opacity: 0.3; }
        .cloud1 { width: 100px; height: 50px; top: 20%; left: 50%; animation: drift 10s linear infinite alternate; }
        .cloud2 { width: 80px; height: 40px; top: 50%; left: 10%; animation: drift 15s linear infinite alternate-reverse; }
        .rain-drop { position: absolute; width: 1px; height: 10px; background: #9ca3af; animation: fall 1s linear infinite; }
        
        /* Sticky Notes Styles */
        #notes-container { position: relative; height: 250px; }
        .sticky-note { position: absolute; width: 120px; height: 120px; padding: 8px; background-color: rgba(254, 240, 138, 0.8); color: #374151; font-size: 14px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 4px; cursor: move; resize: both; overflow: auto; }
        .sticky-note:focus-within { z-index: 20; }
        .delete-note-btn { position: absolute; top: 2px; right: 2px; width: 16px; height: 16px; background: rgba(0,0,0,0.2); color: white; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 10px; opacity: 0; }
        .sticky-note:hover .delete-note-btn { opacity: 1; }
        #add-note-btn { position: absolute; top: -12px; right: -12px; z-index: 25; width: 32px; height: 32px; background: #facc15; color: #1f2937; border-radius: 50%; border: none; font-size: 24px; line-height: 1; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            cursor: se-resize;
            z-index: 20;
        }

        @keyframes spin { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }
        @keyframes drift { from { transform: translateX(-30%); } to { transform: translateX(30%); } }
        @keyframes fall { from { transform: translateY(0px); opacity: 1; } to { transform: translateY(200px); opacity: 0; } }

        #bg-video-darkoverlay {
            content: "";
            position: absolute;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            background: linear-gradient(
                rgba(0, 0, 0, 0.5),
                rgba(0,0,0,0.1)
            );
        }
        #bg-video video {
            position: absolute;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            object-fit: cover;
            z-index: 0;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-black text-gray-100 overflow-hidden">
    <div id="bg-video" style="position: fixed; top:0; left:0; width:100vw; height:100vh; z-index:0; pointer-events:none;"></div>
    <div id="bg-video-darkoverlay"></div>
    
    <div id="dashboard-container" class="relative w-full h-screen p-4">
        <!-- Widgets will be dynamically inserted here -->
    </div>

    <!-- Event Modal (Existing) -->
    <div id="event-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-96"><h3 class="text-lg font-bold mb-4">Add Event</h3><input type="text" id="event-input" class="w-full bg-gray-700 text-white rounded-md p-2 mb-4 focus:outline-none focus:ring-2 focus:ring-purple-400" placeholder="Event details..."><div class="flex justify-end space-x-2"><button id="cancel-event-btn" class="px-4 py-2 bg-gray-600 rounded-md hover:bg-gray-500">Cancel</button><button id="save-event-btn" class="px-4 py-2 bg-purple-500 rounded-md hover:bg-purple-600">Save</button></div></div>
    </div>
    
    <!-- Context Menu (Updated) -->
    <div id="context-menu-container" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-2 rounded-lg shadow-xl w-60 flex flex-col space-y-1">
            <button id="add-widget-btn" class="w-full text-left px-4 py-2 rounded-md hover:bg-gray-700">Add Widget</button>
            <button id="reset-widgets-btn" class="w-full text-left px-4 py-2 rounded-md hover:bg-gray-700">Reset Widgets</button>
            <button id="toggle-collapse-btn" class="w-full text-left px-4 py-2 rounded-md hover:bg-gray-700">Collapse All Widgets</button>
            <button id="toggle-bg-btn" class="w-full text-left px-4 py-2 rounded-md hover:bg-gray-700">Toggle Background</button>
            <div class="border-t border-gray-700 my-1"></div>
            <button id="show-settings-btn" class="w-full text-left px-4 py-2 rounded-md hover:bg-gray-700">Settings</button>
            <div class="border-t border-gray-700 my-1"></div>
            <div class="w-full text-left px-4 py-2">OpenDashboard 2.1</div>
        </div>
    </div>

    <!-- Editor Modal -->
    <div id="widget-editor-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-[100]" style="display: none;">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-[90vw] max-w-[380px] max-h-[90vh] flex flex-col">
            <h3 id="widget-editor-title" class="text-lg font-bold mb-4">Add New Widget</h3>
            <div class="flex-grow flex flex-col space-y-4 overflow-hidden">
                <div>
                    <label for="widget-title-input" class="block text-sm font-medium text-gray-300 mb-1">Widget Title</label>
                    <input type="text" id="widget-title-input" class="w-full bg-white/10 text-white rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-purple-400">
                </div>
                <div>
                    <label for="widget-icon-input" class="block text-sm font-medium text-gray-300 mb-1">Icon SVG</label>
                    <textarea id="widget-icon-input" rows="2" class="w-full bg-white/10 text-white rounded-md p-2 text-sm resize-none focus:outline-none focus:ring-2 focus:ring-purple-400"></textarea>
                </div>
                <div>
                    <label for="widget-code-input" class="block text-sm font-medium text-gray-300 mb-1">Widget Code (HTML & Script)</label>
                    <textarea id="widget-code-input" class="w-full bg-gray-700 text-white rounded-md p-2 font-mono text-sm resize-none focus:outline-none focus:ring-2 focus:ring-purple-400 h-[200px]" placeholder="Enter widget HTML and script code here..."></textarea>
                </div>
                <div id="widget-preview" class="w-full bg-gray-900 border border-gray-700 rounded-md p-4 text-center text-gray-400 overflow-auto flex-grow h-[200px]">
                    Preview will appear here.
                </div>
            </div>
            <div class="flex justify-end space-x-2 mt-4">
                <button id="preview-widget-btn" class="px-4 py-2 bg-gray-600 rounded-md hover:bg-gray-500">Preview</button>
                <button id="cancel-widget-btn" class="px-4 py-2 bg-gray-600 rounded-md hover:bg-gray-500">Cancel</button>
                <button id="save-widget-btn" class="px-4 py-2 bg-purple-500 rounded-md hover:bg-purple-600">Save Widget</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal for Deletion -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-[101]" style="display: none;">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-80 max-w-[90vw] flex flex-col">
            <p id="confirmation-message" class="text-white text-center mb-6">Are you sure you want to delete this widget?</p>
            <div class="flex justify-around space-x-4">
                <button id="confirm-yes-btn" class="flex-1 px-4 py-2 bg-red-600 rounded-md hover:bg-red-500 font-semibold">Yes</button>
                <button id="confirm-no-btn" class="flex-1 px-4 py-2 bg-gray-600 rounded-md hover:bg-gray-500">No</button>
            </div>
        </div>
    </div>
    
    <script src="default_widgets.js"></script>
    <script src="widget_petgame.js"></script>
    <script src="camera.js"></script>

    <script>
        // --- GLOBAL CONFIG & STATE ---
        const LS_WIDGET_POSITIONS_KEY = 'OpenDashboard_DashboardWidgetPositions';
        const LS_TODO_ITEMS_KEY = 'OpenDashboard_TodoListItems';
        const LS_BACKGROUND_URL_KEY = 'OpenDashboard_BackgroundImageURL';
        const LS_BACKGROUND_HIDDEN_KEY = 'OpenDashboard_BackgroundHidden';
        const LS_CUSTOM_WIDGETS_KEY = 'OpenDashboard_CustomWidgets'; // New key for custom widgets
        const LS_WIDGET_VISIBILITY_KEY = 'OpenDashboard_WidgetVisibility'; // New key for widget visibility
        const LS_BACKGROUND_MODE = "OpenDashboard_BackgroundMode";
        
        // Use this global variable to show or hide the close button on custom widgets
        const SHOW_WIDGET_CLOSE_BUTTON = true;

        let highestZ = 10;
        
        const DEFAULT_WIDGET_ICON = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-300"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.29 7.5 12 12.72 20.71 7.5"></polyline><line x1="12" y1="22.72" x2="12" y2="12"></line></svg>`;

        function jsonSerialize(model) {
            var json = JSON.stringify(model);
            return json;
        }

        /**
         * @param {string} message - The message to display in the confirmation modal.
         * @param {function} onConfirm - The function to call if the user confirms.
         */
        function showConfirmationModal(message, onConfirm) {
            const modal = document.getElementById('confirmation-modal');
            const messageEl = document.getElementById('confirmation-message');
            const yesBtn = document.getElementById('confirm-yes-btn');
            const noBtn = document.getElementById('confirm-no-btn');
            
            messageEl.textContent = message;
            modal.style.display = 'flex';

            const handleYes = () => {
                onConfirm();
                modal.style.display = 'none';
                yesBtn.removeEventListener('click', handleYes);
                noBtn.removeEventListener('click', handleNo);
            };

            const handleNo = () => {
                modal.style.display = 'none';
                yesBtn.removeEventListener('click', handleYes);
                noBtn.removeEventListener('click', handleNo);
            };

            yesBtn.addEventListener('click', handleYes);
            noBtn.addEventListener('click', handleNo);
        }
        
        function setBackgroundWallpaper(
            url,
            backdropStartOpacity = 0.3,
            backdropEndOpacity = 0.0
        ) {
            document.body.style.backgroundImage = `
                linear-gradient(
                    rgba(0, 0, 0, ${backdropStartOpacity}),
                    rgba(0, 0, 0, ${backdropEndOpacity})
                ),
                url('${url}')
            `;
        }

        function applyBackground() {
            backgroundMode = localStorage.getItem(LS_BACKGROUND_MODE) || 'image';
            const bgOverlay = getElementById('bg-video-darkoverlay');

            // set background image first
            const bgUrl = localStorage.getItem(LS_BACKGROUND_URL_KEY);
            if(bgUrl)
                setBackgroundWallpaper(bgUrl);

            if (backgroundMode === 'camera') {
                showCameraBackground();
                // show the background overlay
                bgOverlay.style.display = 'block';
            } else {
                // hide the overlay for image mode
                bgOverlay.style.display = 'none';
            }
        }

        function applySavedSettings() {
            applyBackground();

            // Apply background visibility
            const isBgHidden = localStorage.getItem(LS_BACKGROUND_HIDDEN_KEY) === 'true';
            if (isBgHidden) {
                document.body.classList.add('bg-hidden');
            }
        }

        function saveWidgetPositions() {
            const positions = {};
            document.querySelectorAll('.widget').forEach(widget => {
                positions[widget.id] = { 
                    left: widget.style.left, 
                    top: widget.style.top,
                    width: widget.style.width,
                    height: widget.style.height,
                    isMinimized: widget.classList.contains('minimized')
                };
            });
            localStorage.setItem(LS_WIDGET_POSITIONS_KEY, jsonSerialize(positions));
        }

        function saveWidgetPosition(widgetId, widgetPosition) {
            const positions = JSON.parse(localStorage.getItem(LS_WIDGET_POSITIONS_KEY)) || {};
            positions[widgetId] = widgetPosition;
            localStorage.setItem(LS_WIDGET_POSITIONS_KEY, jsonSerialize(positions));
        }

        function getWidgetById(id) {
            return document.getElementById(id);
        }

        function getElementById(id) {
            return document.getElementById(id);
        }
        
        function loadWidgetPositions() {
            const savedPositions = JSON.parse(localStorage.getItem(LS_WIDGET_POSITIONS_KEY));
            if (savedPositions) {
                Object.keys(savedPositions).forEach(id => {
                    loadWidgetPosition(id, savedPositions[id]);
                });
            } else {
                applyDefaultLayout();
            }
        }
        
        function loadWidgetPosition(id, widgetPosData) {
            const widget = document.getElementById(id);
            if (!widget || !widgetPosData) return;

            widget.style.left = widgetPosData.left;
            widget.style.top = widgetPosData.top;

            if (widgetPosData.width && !widgetPosData.isMinimized) {
                widget.style.width = widgetPosData.width;
            }

            if (widgetPosData.height && !widgetPosData.isMinimized) {
                widget.style.height = widgetPosData.height;
            }

            if (widgetPosData.isMinimized) {
                widget.classList.add('minimized');
            } else {
                widget.classList.remove('minimized');
            }
        }

        function loadWidgetPositionById(widgetId) {
            const widget = getWidgetById(widgetId);
            if (!widget) return;
            loadWidgetPositionByWidget(widget.id);
        }

        function loadWidgetPositionByWidget(widget) {
            if (!widget) return;

            const widgetPosData = {
                top: widget.style.top,
                left: widget.style.left,
                width: widget.style.width,
                height: widget.style.height,
                isMinimized: widget.classList.contains('minimized')
            };

            loadWidgetPosition(widget.id, widgetPosData);
        }

        function resetWidgetPositionsAndState() {
            // Clear all relevant local storage items
            localStorage.removeItem(LS_WIDGET_POSITIONS_KEY);
            //localStorage.removeItem(LS_TODO_ITEMS_KEY);
            //localStorage.removeItem(LS_BACKGROUND_URL_KEY);
            //localStorage.removeItem(LS_BACKGROUND_HIDDEN_KEY);

            window.location.reload();
        }
 
        // resets the state "minimized" and position
        function applyDefaultLayout() {
            let topOffset = 20;
            document.querySelectorAll('.widget').forEach(widget => {
                widget.classList.add('minimized');
                widget.style.left = '20px';
                widget.style.top = `${topOffset}px`;
                topOffset += 80;
            });
            saveWidgetPositions();
        }

        /**
         * Creates a generic widget container.
         * @param {string} id - The ID for the widget element.
         * @param {string} iconSVG - The SVG string for the widget's icon.
         * @param {string} title - The title of the widget.
         * @param {string[]} classes - An array of TailwindCSS classes for sizing (e.g., ['w-72']).
         * @param {boolean} isCustom - True if this is a user-created widget.
         * @returns {{widget: HTMLElement, content: HTMLElement, header: HTMLElement}} - The widget element, its content container, and header.
         */
        function createWidget(id, iconSVG, title, classes = [], isCustom = false) {
            const widget = document.createElement('div');
            widget.id = id;
            widget.className = `widget rounded-xl ${classes.join(' ')}`;

            const header = document.createElement('div');
            header.className = 'widget-header flex items-center p-3 border-b border-white/20';
            
            const iconContainer = document.createElement('div');
            iconContainer.className = 'icon-container w-4 h-6 mr-3 flex items-center justify-center';
            iconContainer.innerHTML = iconSVG;

            const titleSpan = document.createElement('span');
            titleSpan.className = 'title-text font-semibold flex-grow';
            titleSpan.textContent = title;

            header.appendChild(iconContainer);
            header.appendChild(titleSpan);
            
            // Add settings button for custom widgets
            if (isCustom) {
                const deleteButton = document.createElement('button');
                deleteButton.className = 'close-widget-btn text-gray-400 hover:text-white ml-2';
                // Use the global variable to control visibility
                if (!SHOW_WIDGET_CLOSE_BUTTON) {
                    deleteButton.style.display = 'none';
                }
                deleteButton.innerHTML = `&#x2715;`; // 'X' symbol
                deleteButton.onclick = (e) => {
                    e.stopPropagation();
                    showConfirmationModal(`Are you sure you want to delete "${title}"?`, () => {
                        widget.remove();
                        saveWidgetPositions();
                        removeCustomWidget(id);
                        // Refresh the custom widget list in the settings panel
                        //initSettingsWidget();
                    });
                };
                
                const settingsBtn = document.createElement('button');
                settingsBtn.className = 'text-gray-400 hover:text-white ml-2 edit-widget-btn';
                settingsBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`;
                settingsBtn.onclick = (e) => {
                    e.stopPropagation();
                    const widgetData = JSON.parse(localStorage.getItem(LS_CUSTOM_WIDGETS_KEY)).find(w => w.id === id);
                    if (widgetData) {
                        // Pass all data to the editor modal
                        initWidgetEditorModal('update', widgetData.id, widgetData.code, widgetData.title, widgetData.iconSVG);
                    }
                };
                header.appendChild(settingsBtn);
                header.appendChild(deleteButton);
            }

            const content = document.createElement('div');
            content.className = 'widget-content p-4 relative h-full';

            const resizeGripper = document.createElement('div');
            resizeGripper.className = 'resize-gripper';
            resizeGripper.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-grip-diagonal" viewBox="0 0 16 16"><path d="M7 2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm2 2a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm-2 2a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm2 2a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm-2 2a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm2 2a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1z"/></svg>`;

            widget.appendChild(header);
            widget.appendChild(content);
            widget.appendChild(resizeGripper);
            widget.style.zIndex = ++highestZ;

            return { widget, content, header };
        }
        
        function centerWidget(widget) {
            if (!widget) return;

            const widgetWidth = widget.offsetWidth;
            const widgetHeight = widget.offsetHeight;
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;

            widget.style.position = "absolute"; // ensure it's positionable
            widget.style.left = `${(screenWidth - widgetWidth) / 2}px`;
            widget.style.top = `${(screenHeight - widgetHeight) / 2}px`;
        }

        function applyWidgetCoreFunctionality(widget) {
            const header = widget.querySelector('.widget-header');
            const resizeHandle = widget.querySelector('.resize-gripper');
            let activeWidget = null;
            let offsetX = 0, offsetY = 0;
            let didDrag = false;

            const onMouseDown = (e) => {
                if (e.target.closest('button, input, .sticky-note, [contenteditable], .resize-gripper')) return;
                if (e.button !== 0 && e.type !== 'touchstart') return;
                
                highestZ++;
                widget.style.zIndex = highestZ;
                didDrag = false;
                activeWidget = widget;
                activeWidget.classList.add('dragging');
                
                const touch = e.type === 'touchstart' ? e.touches[0] : e;
                const rect = activeWidget.getBoundingClientRect();
                offsetX = touch.clientX - rect.left;
                offsetY = touch.clientY - rect.top;

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
                document.addEventListener('touchmove', onMouseMove, { passive: false });
                document.addEventListener('touchend', onMouseUp);
            };

            const onMouseMove = (e) => {
                if (!activeWidget) return;
                didDrag = true;
                e.preventDefault();
                
                const touch = e.type === 'touchmove' ? e.touches[0] : e;
                let newX = touch.clientX - offsetX;
                let newY = touch.clientY - offsetY;

                const container = document.getElementById('dashboard-container');
                const containerRect = container.getBoundingClientRect();
                const widgetRect = activeWidget.getBoundingClientRect();
                newX = Math.max(0, Math.min(newX, containerRect.width - widgetRect.width));
                newY = Math.max(0, Math.min(newY, containerRect.height - widgetRect.height));

                activeWidget.style.left = `${newX}px`;
                activeWidget.style.top = `${newY}px`;
            };

            const onMouseUp = () => {
                if (!activeWidget) return;
                activeWidget.classList.remove('dragging');
                if (didDrag) saveWidgetPositions();
                activeWidget = null;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
                document.removeEventListener('touchmove', onMouseMove);
                document.removeEventListener('touchend', onMouseUp);
            };
            
            const toggleMinimize = (e) => {
                if (didDrag) return;
                if (e.target.closest('.widget-header') && !e.target.closest('.close-widget-btn, .edit-widget-btn')) {
                    widget.classList.toggle('minimized');
                    saveWidgetPositions(); // Save state after toggling
                }
            };

            header.addEventListener('mousedown', onMouseDown);
            header.addEventListener('touchstart', onMouseDown);
            header.addEventListener('click', toggleMinimize);

            // --- Resizing Logic ---
            let initialWidth, initialHeight, initialMouseX, initialMouseY;

            function onResizeMouseDown(e) {
                e.preventDefault();
                e.stopPropagation();

                widget.classList.add('resizing');
                initialWidth = widget.offsetWidth;
                initialHeight = widget.offsetHeight;
                initialMouseX = e.clientX || e.touches[0].clientX;
                initialMouseY = e.clientY || e.touches[0].clientY;

                document.addEventListener('mousemove', onResizeMouseMove);
                document.addEventListener('mouseup', onResizeMouseUp);
                document.addEventListener('touchmove', onResizeMouseMove, { passive: false });
                document.addEventListener('touchend', onResizeMouseUp);
            }

            function onResizeMouseMove(e) {
                e.preventDefault();
                const currentMouseX = e.clientX || e.touches[0].clientX;
                const currentMouseY = e.clientY || e.touches[0].clientY;
                const dx = currentMouseX - initialMouseX;
                const dy = currentMouseY - initialMouseY;

                widget.style.width = `${initialWidth + dx}px`;
                widget.style.height = `${initialHeight + dy}px`;
            }

            function onResizeMouseUp() {
                widget.classList.remove('resizing');
                saveWidgetPositions();
                document.removeEventListener('mousemove', onResizeMouseMove);
                document.removeEventListener('mouseup', onResizeMouseUp);
                document.removeEventListener('touchmove', onResizeMouseMove);
                document.removeEventListener('touchend', onResizeMouseUp);
            }

            resizeHandle.addEventListener('mousedown', onResizeMouseDown);
            resizeHandle.addEventListener('touchstart', onResizeMouseDown);
        }
        
        function removeCustomWidget(id) {
            const widgets = JSON.parse(localStorage.getItem(LS_CUSTOM_WIDGETS_KEY)) || [];
            const updatedWidgets = widgets.filter(w => w.id !== id);
            localStorage.setItem(LS_CUSTOM_WIDGETS_KEY, jsonSerialize(updatedWidgets));
        }
        
        function loadCustomWidgets() {
            const customWidgets = JSON.parse(localStorage.getItem(LS_CUSTOM_WIDGETS_KEY)) || [];
            const visibilityState = JSON.parse(localStorage.getItem(LS_WIDGET_VISIBILITY_KEY)) || {};
            customWidgets.forEach(widgetData => {
                // Check visibility state. Default to visible if not found.
                if (visibilityState[widgetData.id] !== false) {
                    renderWidgetFromData(widgetData);
                }
            });
        }

        /**
         * Parses and renders a widget from its stored data (HTML + script).
         * @param {Object} widgetData - The object containing id and code.
         */
        function renderWidgetFromData(widgetData) {
            const { widget, content } = createWidget(
                widgetData.id,
                widgetData.iconSVG || DEFAULT_WIDGET_ICON,
                widgetData.title || 'Custom Widget',
                ['w-90'],
                true
            );
            
            try {
                // Temporarily append the content to a div to handle scripts
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = widgetData.code;
                
                const scripts = tempDiv.querySelectorAll('script');
                
                // Extract HTML content excluding scripts
                const htmlContent = Array.from(tempDiv.childNodes).filter(node => node.tagName !== 'SCRIPT').map(node => node.outerHTML).join('');
                content.innerHTML = htmlContent;

                document.getElementById('dashboard-container').appendChild(widget);

                // Now execute the scripts
                scripts.forEach(script => {
                    const newScript = document.createElement('script');
                    if (script.src) {
                        newScript.src = script.src;
                    } else {
                        newScript.textContent = script.textContent;
                    }
                    // Use a flag to identify custom widget scripts and prevent duplicates
                    newScript.dataset.widgetId = widgetData.id;
                    document.body.appendChild(newScript);
                });
                
                // apply widget core fns
                applyWidgetCoreFunctionality(widget);

            } catch (e) {
                console.error('Failed to load custom widget:', e);
                content.innerHTML = `<p class="text-red-400">Error loading widget code.</p>`;
            }
        }
        
        /**
         * Initializes the widget editor modal for creating or updating a custom widget.
         * @param {string} mode - 'create' or 'update'.
         * @param {string} widgetId - The ID of the widget being updated (only in 'update' mode).
         * @param {string} initialCode - The starting code for the editor.
         * @param {string} initialTitle - The title of the widget.
         * @param {string} initialIcon - The icon SVG of the widget.
         */
        function initWidgetEditorModal(mode, widgetId = null, initialCode = '', initialTitle = 'Custom Widget', initialIcon = DEFAULT_WIDGET_ICON) {
            const modal = document.getElementById('widget-editor-modal');
            const titleInput = modal.querySelector('#widget-title-input');
            const iconInput = modal.querySelector('#widget-icon-input');
            const codeInput = modal.querySelector('#widget-code-input');
            const previewBtn = modal.querySelector('#preview-widget-btn');
            const saveBtn = modal.querySelector('#save-widget-btn');
            const cancelBtn = modal.querySelector('#cancel-widget-btn');
            const previewContainer = modal.querySelector('#widget-preview');
            
            // Set initial state based on mode
            titleInput.value = initialTitle;
            iconInput.value = initialIcon;
            codeInput.value = initialCode;
            previewContainer.innerHTML = '';
            modal.style.display = 'flex';
            
            // Function to clean up old preview scripts
            function cleanupPreviewScripts() {
                document.querySelectorAll('.preview-script').forEach(script => script.remove());
            }

            const handleSave = () => {
                const title = titleInput.value || 'Custom Widget';
                const iconSVG = iconInput.value || DEFAULT_WIDGET_ICON;
                const code = codeInput.value;
                const widgetData = { id: widgetId, title, iconSVG, code };
                let customWidgets = JSON.parse(localStorage.getItem(LS_CUSTOM_WIDGETS_KEY)) || [];
                
                if (mode === 'create')
                {
                    widgetData.id = 'custom-widget-' + Date.now();
                    customWidgets.push(widgetData);
                    localStorage.setItem(LS_CUSTOM_WIDGETS_KEY, jsonSerialize(customWidgets));
                    renderWidgetFromData(widgetData);
                    const widget = getWidgetById(widgetData.id);
                    if(widget)
                        centerWidget(widget);
                } 
                else if (mode === 'update')
                {
                    const index = customWidgets.findIndex(w => w.id === widgetId);
                    if (index !== -1) 
                    {
                        customWidgets[index] = widgetData;
                    }
                    
                    localStorage.setItem(LS_CUSTOM_WIDGETS_KEY, jsonSerialize(customWidgets));

                    const oldWidget = getWidgetById(widgetId);
                    if (oldWidget) 
                        oldWidget.remove();

                    const oldScript = document.querySelector(`script[data-widget-id="${widgetId}"]`);
                    if (oldScript) 
                        oldScript.remove();

                    renderWidgetFromData(widgetData);
                    loadWidgetPositionByWidget(oldWidget);
                }
                
                cleanupPreviewScripts();
                modal.style.display = 'none';
                
                // Refresh the custom widget list in the settings panel
                //initSettingsWidget();
            };
            
            const handlePreview = () => {
                const code = codeInput.value;
                cleanupPreviewScripts();
                previewContainer.innerHTML = '';
                
                try {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = code;
                    
                    const scripts = tempDiv.querySelectorAll('script');
                    const htmlContent = Array.from(tempDiv.childNodes).filter(node => node.tagName !== 'SCRIPT').map(node => node.outerHTML).join('');
                    previewContainer.innerHTML = htmlContent;

                    scripts.forEach(script => {
                        const newScript = document.createElement('script');
                        newScript.className = 'preview-script';
                        if (script.src) {
                            newScript.src = script.src;
                        } else {
                            newScript.textContent = script.textContent;
                        }
                        // Append the script to the preview container to execute it
                        previewContainer.appendChild(newScript);
                    });
                    
                } catch(e) {
                    previewContainer.innerHTML = `<p class="text-red-400">Error rendering code. Check your syntax.</p>`;
                }
            };

            saveBtn.onclick = handleSave;
            previewBtn.onclick = handlePreview;
            cancelBtn.onclick = () => { 
                cleanupPreviewScripts();
                modal.style.display = 'none';
            };
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    cleanupPreviewScripts();
                    modal.style.display = 'none';
                }
            });
        }
        
        // CONTEXT MENU
        // The context menu when you long press on 
        // any of the available space in widget container -- "the desktop" LOL
        function initContextMenu() {
            const dashboardContainer = document.getElementById('dashboard-container');
            const contextMenu = document.getElementById('context-menu-container');
            const addWidgetBtn = document.getElementById('add-widget-btn');
            const resetBtn = document.getElementById('reset-widgets-btn');
            const toggleCollapseBtn = document.getElementById('toggle-collapse-btn');
            const toggleBgBtn = document.getElementById('toggle-bg-btn');
            const showSettingsBtn = document.getElementById('show-settings-btn');
            let longPressTimer;
            let startX, startY;

            function showContextMenu() { contextMenu.style.display = 'flex'; }
            function hideContextMenu() { contextMenu.style.display = 'none'; }

            dashboardContainer.addEventListener('mousedown', e => {
                if (e.target !== dashboardContainer) return;
                startX = e.clientX;
                startY = e.clientY;
                longPressTimer = setTimeout(showContextMenu, 500);
            });
            dashboardContainer.addEventListener('mouseup', () => clearTimeout(longPressTimer));
            dashboardContainer.addEventListener('mousemove', e => {
                if (Math.abs(e.clientX - startX) > 5 || Math.abs(e.clientY - startY) > 5) {
                    clearTimeout(longPressTimer);
                }
            });
            
            dashboardContainer.addEventListener('touchstart', e => {
                if (e.target !== dashboardContainer) return;
                const touch = e.touches[0];
                startX = touch.clientX;
                startY = touch.clientY;
                longPressTimer = setTimeout(showContextMenu, 500);
            });
            dashboardContainer.addEventListener('touchend', () => clearTimeout(longPressTimer));
            dashboardContainer.addEventListener('touchmove', e => {
                const touch = e.touches[0];
                if (Math.abs(touch.clientX - startX) > 10 || Math.abs(touch.clientY - startY) > 10) {
                    clearTimeout(longPressTimer);
                }
            });

            contextMenu.addEventListener('click', (e) => {
                if (e.target === contextMenu) hideContextMenu();
            });
            
            addWidgetBtn.addEventListener('click', () => {
                initWidgetEditorModal('create');
                hideContextMenu();
            });

            resetBtn.addEventListener('click', () => {
                resetWidgetPositionsAndState();
            });

            toggleCollapseBtn.addEventListener('click', () => {
                const isCollapsed = toggleCollapseBtn.textContent.includes('Collapse');
                document.querySelectorAll('.widget').forEach(w => {
                    if (isCollapsed) {
                        w.classList.add('minimized');
                    } else {
                        w.classList.remove('minimized');
                    }
                });
                toggleCollapseBtn.textContent = isCollapsed ? 'Expand All Widgets' : 'Collapse All Widgets';
                saveWidgetPositions();
                hideContextMenu();
            });

            toggleBgBtn.addEventListener('click', () => {
                document.body.classList.toggle('bg-hidden');
                localStorage.setItem(LS_BACKGROUND_HIDDEN_KEY, document.body.classList.contains('bg-hidden'));
                hideContextMenu();
            });

            showSettingsBtn.addEventListener('click', () => {
                const settingsWidget = document.getElementById('settings-widget');
                if (!settingsWidget) {
                    initSettingsWidget();
                } else {
                    // If it exists but was minimized, un-minimize it
                    settingsWidget.classList.remove('minimized');
                    settingsWidget.style.zIndex = ++highestZ;
                }
                hideContextMenu();
            });
        }

        // this is the settings widget when we click/tap on
        // Settings context menu item. 
        function initSettingsWidget() {
            var backgroundMode = "image";

            const existingWidget = document.getElementById('settings-widget');
            if (existingWidget) {
                existingWidget.remove();
            }

            const icon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-300"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>`;
            const { widget, content, header } = createWidget('settings-widget', icon, 'Settings', ['w-94', 'min-h-[400px]']);
            
            const currentBg = localStorage.getItem(LS_BACKGROUND_URL_KEY) || 'https://images.pexels.com/photos/212324/pexels-photo-212324.jpeg';
            const currentMode = localStorage.getItem(LS_BACKGROUND_MODE) || 'image';

            content.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Background Source</label>
                        <div class="flex space-x-4 mb-2">
                            <label class="flex items-center">
                                <input type="radio" name="bg-mode" value="image" ${currentMode === 'image' ? 'checked' : ''} class="mr-2">
                                <span>Image</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="bg-mode" value="camera" ${currentMode === 'camera' ? 'checked' : ''} class="mr-2">
                                <span>Camera</span>
                            </label>
                        </div>
                        <div id="bg-url-group" ${currentMode === 'camera' ? 'style="display:none;"' : ''}>
                            <label for="bg-url-input" class="block text-sm font-medium text-gray-300 mb-1">Background Image URL</label>
                            <input type="text" id="bg-url-input" class="w-full bg-white/10 text-white rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-purple-400" value="${currentBg}">
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button id="save-bg-btn" class="px-4 py-2 bg-purple-500 rounded-md hover:bg-purple-600">Save</button>
                    </div>
                    <div class="border-t border-gray-700 pt-4">
                        <h4 class="font-semibold text-sm mb-2">Custom Widget Manager</h4>
                        <div id="custom-widgets-list" class="space-y-2 max-h-40 overflow-y-auto">
                            <!-- Widget list will be dynamically populated here -->
                        </div>
                    </div>
                    <div class="border-t border-gray-700 pt-4">
                        <h4 class="font-semibold text-sm mb-2">Data Management</h4>
                        <div class="flex justify-between space-x-2">
                            <button id="export-data-btn" class="flex-1 px-4 py-2 bg-blue-500 rounded-md hover:bg-blue-600">Export All Data</button>
                            <button id="import-data-btn" class="flex-1 px-4 py-2 bg-green-500 rounded-md hover:bg-green-600">Import Data</button>
                        </div>
                        <input type="file" id="import-file-input" class="hidden" accept=".json">
                    </div>
                </div>
            `;
            
            const closeButton = document.createElement('button');
            closeButton.className = 'close-widget-btn text-gray-400 hover:text-white ml-2';
            closeButton.innerHTML = `&#x2715;`; // 'X' symbol
            closeButton.onclick = (e) => {
                e.stopPropagation();
                widget.remove(); // This will close/hide the widget by removing it
            };
            header.appendChild(closeButton);

            document.getElementById('dashboard-container').appendChild(widget);
            
            centerWidget(widget);
            
            applyWidgetCoreFunctionality(widget);

            const modeRadios = content.querySelectorAll('input[name="bg-mode"]');
            modeRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const mode = e.target.value;
                    backgroundMode = mode;
                    localStorage.setItem(LS_BACKGROUND_MODE, backgroundMode);
                });
            });
            
            const saveBtn = content.querySelector('#save-bg-btn');
            const input = content.querySelector('#bg-url-input');
            const exportBtn = content.querySelector('#export-data-btn');
            const importBtn = content.querySelector('#import-data-btn');
            const importInput = content.querySelector('#import-file-input');
            const customWidgetsList = content.querySelector('#custom-widgets-list');

            saveBtn.addEventListener('click', () => {
                // just apply the backgroundImage regardless of mode
                const newUrl = input.value.trim();
                if (newUrl) 
                    localStorage.setItem(LS_BACKGROUND_URL_KEY, newUrl);

                if (backgroundMode === 'image')
                    removeCameraVideo();

                applyBackground();
            });
            
            exportBtn.addEventListener('click', () => {
                const data = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    try {
                        data[key] = JSON.parse(localStorage.getItem(key));
                    } catch (e) {
                        data[key] = localStorage.getItem(key);
                    }
                }
                const jsonString = jsonSerialize(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'dashboard_data.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });

            importBtn.addEventListener('click', () => {
                importInput.click();
            });

            importInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        localStorage.clear();
                        for (const key in importedData) {
                            if (importedData.hasOwnProperty(key)) {
                                if (typeof importedData[key] === 'object') {
                                    localStorage.setItem(key, jsonSerialize(importedData[key]));
                                } else {
                                    localStorage.setItem(key, importedData[key]);
                                }
                            }
                        }
                        window.location.reload();
                    } catch (error) {
                        console.error('Failed to parse imported file:', error);
                    }
                };
                reader.readAsText(file);
            });

            function renderCustomWidgetsList() {
                const customWidgets = JSON.parse(localStorage.getItem(LS_CUSTOM_WIDGETS_KEY)) || [];
                const visibilityState = JSON.parse(localStorage.getItem(LS_WIDGET_VISIBILITY_KEY)) || {};
                
                customWidgetsList.innerHTML = ''; // Clear the list
                
                if (customWidgets.length === 0) {
                    customWidgetsList.innerHTML = `<p class="text-gray-400 text-center text-sm">No custom widgets found.</p>`;
                    return;
                }
                
                customWidgets.forEach(widgetData => {
                    const isVisible = visibilityState[widgetData.id] !== false;
                    const listItem = document.createElement('div');
                    listItem.className = 'flex items-center justify-between p-2 rounded-md bg-white/5';
                    
                    listItem.innerHTML = `
                        <span class="text-sm truncate mr-2">${widgetData.title}</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" data-widget-id="${widgetData.id}" class="sr-only peer" ${isVisible ? 'checked' : ''}>
                            <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                        </label>
                    `;
                    
                    customWidgetsList.appendChild(listItem);
                });
                
                // Add event listeners after populating the list
                customWidgetsList.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', (e) => {
                        const widgetId = e.target.dataset.widgetId;
                        const isChecked = e.target.checked;
                        
                        const currentVisibility = JSON.parse(localStorage.getItem(LS_WIDGET_VISIBILITY_KEY)) || {};
                        currentVisibility[widgetId] = isChecked;
                        localStorage.setItem(LS_WIDGET_VISIBILITY_KEY, jsonSerialize(currentVisibility));
                        
                        const targetWidget = document.getElementById(widgetId);
                        if (targetWidget) {
                            targetWidget.style.display = isChecked ? 'block' : 'none';
                        }
                    });
                });
            }

            renderCustomWidgetsList();

            return widget;
        }
            
        document.addEventListener('DOMContentLoaded', () => {
            async function defaultWidgets() {
                await initDefaultWidgets();
            }
            
            async function initThirdPartyWidgets() {
                //await initPetGame();
            }

            // --- MAIN EXECUTION ---
            async function main() {
                // Initialize the context menu
                initContextMenu();

                // Apply saved settings first
                applySavedSettings();

                // Create all default widgets, 3rd party widgets
                // and apply functionality.
                await defaultWidgets();
                await initThirdPartyWidgets();
                
                // Apply core functionality to all the built ins and 3rd parties
                document.querySelectorAll('.widget').forEach(applyWidgetCoreFunctionality);

                // Load custom widgets and apply functionality.
                // no need to apply the core fns here. 
                loadCustomWidgets();

                // Finally, load their positions from storage, or apply default
                loadWidgetPositions();
            }

            main();
        });
    </script>
</body>
</html>

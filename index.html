<!-- 

MIT License

Copyright (c) 2025 Jayson Ragasa

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.

-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Widgets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for the dashboard and widgets */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            touch-action: none; /* Prevent default touch actions like scrolling when dragging */
            background-image: url('https://images.pexels.com/photos/1025469/pexels-photo-1025469.jpeg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            transition: background 0.5s ease-in-out;
        }

        body.bg-hidden {
            background-image: none !important;
            background-color: #111827;
        }

        .widget {
            position: absolute;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(9px);
            -webkit-backdrop-filter: blur(9px);
			border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
			box-shadow: 
				0 8px 32px rgba(0, 0, 0, 0.3),
				inset 0 1px 0 rgba(255, 255, 255, 0.5),
				inset 0 -1px 0 rgba(255, 255, 255, 0.1),
				inset 0 0 14px 7px rgba(255, 255, 255, 0.1);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out, width 0.3s ease-in-out, height 0.3s ease-in-out;
            z-index: 10;
            overflow: hidden;
            min-width: 280px; /* Prevent widgets from becoming too small */
            min-height: 200px;
			padding-bottom: 50px;
        }
		
		.widget::before {
		  content: '';
		  position: absolute;
		  top: 0;
		  left: 0;
		  right: 0;
		  height: 1px;
		  background: linear-gradient(
			90deg,
			transparent,
			rgba(255, 255, 255, 0.8),
			transparent
		  );
		}

		.widget::after {
		  content: '';
		  position: absolute;
		  top: 0;
		  left: 0;
		  width: 1px;
		  height: 100%;
		  background: linear-gradient(
			180deg,
			rgba(255, 255, 255, 0.8),
			transparent,
			rgba(255, 255, 255, 0.3)
		  );
		}
		
        .dark .widget {
             background: rgba(17, 24, 39, 0.1);
             border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .widget-header {
            cursor: move;
            user-select: none;
        }
        
        .widget.dragging, .widget.resizing {
            transform: scale(1.02);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transition: none;
        }

        .widget.minimized { 
            width: 64px !important; /* Use !important to override inline styles */
            height: 64px !important; 
            min-width: 64px; /* Override the min-width */
            min-height: 64px; /* Override the min-height */
            overflow: hidden; 
            resize: none; /* Disable resizing when minimized */
        }
        .widget.minimized .widget-content, .widget.minimized .widget-header .title-text, .widget.minimized .resize-gripper { display: none; }
        .widget.minimized .widget-header .icon-container { margin: 0; }
		
		.resize-gripper {
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            cursor: se-resize;
            z-index: 20;
            opacity: 0.3;
            transition: opacity 0.2s;
        }
        .widget:hover .resize-gripper {
            opacity: 0.8;
        }

        .clock-face { width: 150px; height: 150px; border: 2px solid rgba(255, 255, 255, 0.5); border-radius: 50%; position: relative; }
        .hand { width: 50%; position: absolute; top: 50%; transform-origin: 100%; transform: rotate(90deg); transition: transform 0.05s cubic-bezier(0.4, 2.08, 0.55, 0.44); }
        .hour-hand { height: 4px; background: #ffffff; width: 30%; left: 20%; }
        .minute-hand { height: 3px; background: #ffffff; width: 40%; left: 10%; }
        .second-hand { height: 1px; background: #ef4444; width: 45%; left: 5%; }
        .clock-center { width: 8px; height: 8px; background: #ffffff; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100; }

        .todo-item { cursor: pointer; }
        .todo-item.completed span { text-decoration: line-through; color: #d1d5db; }
        .delete-btn { visibility: hidden; opacity: 0; transition: opacity 0.2s ease-in-out; }
        .todo-item:hover .delete-btn { visibility: visible; opacity: 1; }
        .todo-item.dragging { opacity: 0.5; }

        .day-cell { position: relative; }
        .event-indicator { position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); width: 5px; height: 5px; background-color: #ef4444; border-radius: 50%; }
        .day-cell.selected { background-color: rgba(59, 130, 246, 0.5); }
        .day-cell.today { border: 1px solid rgba(255, 255, 255, 0.8); }
        #event-modal, #context-menu-container { display: none; }

        /* Weather Animations */
        .weather-animation-bg { position: absolute; inset: 0; z-index: 0; }
        .sun { position: absolute; top: 30%; left: 50%; width: 60px; height: 60px; background: #facc15; border-radius: 50%; transform: translate(-50%, -50%); }
        .weather-sunny .sun { animation: spin 20s linear infinite; }
        .cloud { position: absolute; background: #e5e7eb; border-radius: 30px; opacity: 0.3; }
        .cloud1 { width: 100px; height: 50px; top: 20%; left: 50%; animation: drift 10s linear infinite alternate; }
        .cloud2 { width: 80px; height: 40px; top: 50%; left: 10%; animation: drift 15s linear infinite alternate-reverse; }
        .rain-drop { position: absolute; width: 1px; height: 10px; background: #9ca3af; animation: fall 1s linear infinite; }
        
        /* Sticky Notes Styles */
        #notes-container { position: relative; height: 250px; }
        .sticky-note { position: absolute; width: 120px; height: 120px; padding: 8px; background-color: rgba(254, 240, 138, 0.8); color: #374151; font-size: 14px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-radius: 4px; cursor: move; resize: both; overflow: auto; }
        .sticky-note:focus-within { z-index: 20; }
        .delete-note-btn { position: absolute; top: 2px; right: 2px; width: 16px; height: 16px; background: rgba(0,0,0,0.2); color: white; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 10px; opacity: 0; }
        .sticky-note:hover .delete-note-btn { opacity: 1; }
        #add-note-btn { position: absolute; top: -12px; right: -12px; z-index: 25; width: 32px; height: 32px; background: #facc15; color: #1f2937; border-radius: 50%; border: none; font-size: 24px; line-height: 1; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 20px;
            height: 20px;
            cursor: se-resize;
            z-index: 20;
        }

        @keyframes spin { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }
        @keyframes drift { from { transform: translateX(-30%); } to { transform: translateX(30%); } }
        @keyframes fall { from { transform: translateY(0px); opacity: 1; } to { transform: translateY(200px); opacity: 0; } }
    </style>
</head>
<body class="bg-black text-gray-100 overflow-hidden">

    <div id="dashboard-container" class="relative w-full h-screen p-4">
        <!-- Widgets will be dynamically inserted here -->
    </div>

    <div id="event-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-lg shadow-xl w-96"><h3 class="text-lg font-bold mb-4">Add Event</h3><input type="text" id="event-input" class="w-full bg-gray-700 text-white rounded-md p-2 mb-4 focus:outline-none focus:ring-2 focus:ring-purple-400" placeholder="Event details..."><div class="flex justify-end space-x-2"><button id="cancel-event-btn" class="px-4 py-2 bg-gray-600 rounded-md hover:bg-gray-500">Cancel</button><button id="save-event-btn" class="px-4 py-2 bg-purple-500 rounded-md hover:bg-purple-600">Save</button></div></div>
    </div>
    
    <div id="context-menu-container" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-2 rounded-lg shadow-xl w-60 flex flex-col space-y-1">
             <button id="reset-widgets-btn" class="w-full text-left px-4 py-2 rounded-md hover:bg-gray-700">Reset Widgets</button>
             <button id="toggle-collapse-btn" class="w-full text-left px-4 py-2 rounded-md hover:bg-gray-700">Collapse All Widgets</button>
             <button id="toggle-bg-btn" class="w-full text-left px-4 py-2 rounded-md hover:bg-gray-700">Toggle Background</button>
             <div class="border-t border-gray-700 my-1"></div>
             <button id="show-settings-btn" class="w-full text-left px-4 py-2 rounded-md hover:bg-gray-700">Settings</button>
        </div>
    </div>
	
	<script src="default_widgets.js"></script>
	<script src="widget_petgame.js"></script>

    <script>
		// --- GLOBAL CONFIG & STATE ---
		const WIDGET_POSITIONS_KEY = 'dashboardWidgetPositions';
		const TODO_ITEMS_KEY = 'todoListItems';
		const BACKGROUND_URL_KEY = 'backgroundImageURL';
		const BACKGROUND_HIDDEN_KEY = 'backgroundHidden';
		let highestZ = 10;

		// --- INITIAL PAGE LOAD ---
		function applySavedSettings() {
			// Apply background image
			const savedBgUrl = localStorage.getItem(BACKGROUND_URL_KEY);
			if (savedBgUrl) {
				document.body.style.backgroundImage = `url('${savedBgUrl}')`;
			}

			// Apply background visibility
			const isBgHidden = localStorage.getItem(BACKGROUND_HIDDEN_KEY) === 'true';
			if (isBgHidden) {
				document.body.classList.add('bg-hidden');
			}
		}

		function saveWidgetPositions() {
			const positions = {};
			document.querySelectorAll('.widget').forEach(widget => {
				positions[widget.id] = { 
					left: widget.style.left, 
					top: widget.style.top,
					width: widget.style.width,
					height: widget.style.height,
					isMinimized: widget.classList.contains('minimized')
				};
			});
			localStorage.setItem(WIDGET_POSITIONS_KEY, JSON.stringify(positions));
		}

		function loadWidgetPositions() {
			const savedPositions = JSON.parse(localStorage.getItem(WIDGET_POSITIONS_KEY));
			if (savedPositions) {
				Object.keys(savedPositions).forEach(id => {
					const widget = document.getElementById(id);
					if (widget) {
						widget.style.left = savedPositions[id].left;
						widget.style.top = savedPositions[id].top;
						if (savedPositions[id].width && !savedPositions[id].isMinimized) {
							widget.style.width = savedPositions[id].width;
						}
						if (savedPositions[id].height && !savedPositions[id].isMinimized) {
							widget.style.height = savedPositions[id].height;
						}
						if (savedPositions[id].isMinimized) {
							widget.classList.add('minimized');
						} else {
							widget.classList.remove('minimized');
						}
					}
				});
			} else {
				applyDefaultLayout();
			}
		}
		
		function applyDefaultLayout() {
			let topOffset = 20;
			document.querySelectorAll('.widget').forEach(widget => {
				widget.classList.add('minimized');
				widget.style.left = '20px';
				widget.style.top = `${topOffset}px`;
				topOffset += 80;
			});
			saveWidgetPositions();
		}

		function applyCoreWidgetFunctionality(widget) {
			const header = widget.querySelector('.widget-header');
			const resizeHandle = widget.querySelector('.resize-gripper');
			let activeWidget = null;
			let offsetX = 0, offsetY = 0;
			let didDrag = false;

			const onMouseDown = (e) => {
				if (e.target.closest('button, input, .sticky-note, [contenteditable], .resize-gripper')) return;
				if (e.button !== 0 && e.type !== 'touchstart') return;
				
				highestZ++;
				widget.style.zIndex = highestZ;
				didDrag = false;
				activeWidget = widget;
				activeWidget.classList.add('dragging');
				
				const touch = e.type === 'touchstart' ? e.touches[0] : e;
				const rect = activeWidget.getBoundingClientRect();
				offsetX = touch.clientX - rect.left;
				offsetY = touch.clientY - rect.top;

				document.addEventListener('mousemove', onMouseMove);
				document.addEventListener('mouseup', onMouseUp);
				document.addEventListener('touchmove', onMouseMove, { passive: false });
				document.addEventListener('touchend', onMouseUp);
			};

			const onMouseMove = (e) => {
				if (!activeWidget) return;
				didDrag = true;
				e.preventDefault();
				
				const touch = e.type === 'touchmove' ? e.touches[0] : e;
				let newX = touch.clientX - offsetX;
				let newY = touch.clientY - offsetY;

				const container = document.getElementById('dashboard-container');
				const containerRect = container.getBoundingClientRect();
				const widgetRect = activeWidget.getBoundingClientRect();
				newX = Math.max(0, Math.min(newX, containerRect.width - widgetRect.width));
				newY = Math.max(0, Math.min(newY, containerRect.height - widgetRect.height));

				activeWidget.style.left = `${newX}px`;
				activeWidget.style.top = `${newY}px`;
			};

			const onMouseUp = () => {
				if (!activeWidget) return;
				activeWidget.classList.remove('dragging');
				if (didDrag) saveWidgetPositions();
				activeWidget = null;
				document.removeEventListener('mousemove', onMouseMove);
				document.removeEventListener('mouseup', onMouseUp);
				document.removeEventListener('touchmove', onMouseMove);
				document.removeEventListener('touchend', onMouseUp);
			};
			
			const toggleMinimize = (e) => {
				if (didDrag) return;
				if (e.target.closest('.widget-header') && !e.target.closest('.close-widget-btn')) {
					widget.classList.toggle('minimized');
					saveWidgetPositions(); // Save state after toggling
				}
			};

			header.addEventListener('mousedown', onMouseDown);
			header.addEventListener('touchstart', onMouseDown);
			header.addEventListener('click', toggleMinimize);

			// --- Resizing Logic ---
			let initialWidth, initialHeight, initialMouseX, initialMouseY;

			function onResizeMouseDown(e) {
				e.preventDefault();
				e.stopPropagation();

				widget.classList.add('resizing');
				initialWidth = widget.offsetWidth;
				initialHeight = widget.offsetHeight;
				initialMouseX = e.clientX || e.touches[0].clientX;
				initialMouseY = e.clientY || e.touches[0].clientY;

				document.addEventListener('mousemove', onResizeMouseMove);
				document.addEventListener('mouseup', onResizeMouseUp);
				document.addEventListener('touchmove', onResizeMouseMove, { passive: false });
				document.addEventListener('touchend', onResizeMouseUp);
			}

			function onResizeMouseMove(e) {
				e.preventDefault();
				const currentMouseX = e.clientX || e.touches[0].clientX;
				const currentMouseY = e.clientY || e.touches[0].clientY;
				const dx = currentMouseX - initialMouseX;
				const dy = currentMouseY - initialMouseY;

				widget.style.width = `${initialWidth + dx}px`;
				widget.style.height = `${initialHeight + dy}px`;
			}

			function onResizeMouseUp() {
				widget.classList.remove('resizing');
				saveWidgetPositions();
				document.removeEventListener('mousemove', onResizeMouseMove);
				document.removeEventListener('mouseup', onResizeMouseUp);
				document.removeEventListener('touchmove', onResizeMouseMove);
				document.removeEventListener('touchend', onResizeMouseUp);
			}

			resizeHandle.addEventListener('mousedown', onResizeMouseDown);
			resizeHandle.addEventListener('touchstart', onResizeMouseDown);
		}
		
		/**
		 * Creates a generic widget container.
		 * @param {string} id - The ID for the widget element.
		 * @param {string} iconSVG - The SVG string for the widget's icon.
		 * @param {string} title - The title of the widget.
		 * @param {string[]} classes - An array of TailwindCSS classes for sizing (e.g., ['w-72']).
		 * @returns {{widget: HTMLElement, content: HTMLElement, header: HTMLElement}} - The widget element, its content container, and header.
		 */
		function createWidget(id, iconSVG, title, classes = []) {
			const widget = document.createElement('div');
			widget.id = id;
			widget.className = `widget rounded-xl ${classes.join(' ')}`;

			const header = document.createElement('div');
			header.className = 'widget-header flex items-center p-3 border-b border-white/20';
			
			const iconContainer = document.createElement('div');
			iconContainer.className = 'icon-container w-6 h-6 mr-3 flex items-center justify-center';
			iconContainer.innerHTML = iconSVG;

			const titleSpan = document.createElement('span');
			titleSpan.className = 'title-text font-semibold flex-grow';
			titleSpan.textContent = title;

			header.appendChild(iconContainer);
			header.appendChild(titleSpan);

			const content = document.createElement('div');
			content.className = 'widget-content p-4 relative h-full'; // Added relative and h-full

			const resizeGripper = document.createElement('div');
			resizeGripper.className = 'resize-gripper';
			resizeGripper.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-grip-diagonal" viewBox="0 0 16 16"><path d="M7 2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm2 2a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm-2 2a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm2 2a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm-2 2a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1zm2 2a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5v-1z"/></svg>`;

			widget.appendChild(header);
			widget.appendChild(content);
			widget.appendChild(resizeGripper);

			return { widget, content, header };
		}
			
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONTEXT MENU ---
            function initContextMenu() {
                const dashboardContainer = document.getElementById('dashboard-container');
                const contextMenu = document.getElementById('context-menu-container');
                const resetBtn = document.getElementById('reset-widgets-btn');
                const toggleCollapseBtn = document.getElementById('toggle-collapse-btn');
                const toggleBgBtn = document.getElementById('toggle-bg-btn');
                const showSettingsBtn = document.getElementById('show-settings-btn');
                let longPressTimer;
                let startX, startY;

                function showContextMenu() { contextMenu.style.display = 'flex'; }
                function hideContextMenu() { contextMenu.style.display = 'none'; }

                dashboardContainer.addEventListener('mousedown', e => {
                    if (e.target !== dashboardContainer) return;
                    startX = e.clientX;
                    startY = e.clientY;
                    longPressTimer = setTimeout(showContextMenu, 500);
                });
                dashboardContainer.addEventListener('mouseup', () => clearTimeout(longPressTimer));
                dashboardContainer.addEventListener('mousemove', e => {
                    if (Math.abs(e.clientX - startX) > 5 || Math.abs(e.clientY - startY) > 5) {
                        clearTimeout(longPressTimer);
                    }
                });
                
                dashboardContainer.addEventListener('touchstart', e => {
                    if (e.target !== dashboardContainer) return;
                    const touch = e.touches[0];
                    startX = touch.clientX;
                    startY = touch.clientY;
                    longPressTimer = setTimeout(showContextMenu, 500);
                });
                dashboardContainer.addEventListener('touchend', () => clearTimeout(longPressTimer));
                dashboardContainer.addEventListener('touchmove', e => {
                    const touch = e.touches[0];
                    if (Math.abs(touch.clientX - startX) > 10 || Math.abs(touch.clientY - startY) > 10) {
                        clearTimeout(longPressTimer);
                    }
                });

                contextMenu.addEventListener('click', (e) => {
                    if (e.target === contextMenu) hideContextMenu();
                });

                resetBtn.addEventListener('click', () => {
                    // Clear all relevant local storage items
                    localStorage.removeItem(WIDGET_POSITIONS_KEY);
                    localStorage.removeItem(TODO_ITEMS_KEY);
                    //localStorage.removeItem(BACKGROUND_URL_KEY);
                    localStorage.removeItem(BACKGROUND_HIDDEN_KEY);
                    window.location.reload();
                });

                toggleCollapseBtn.addEventListener('click', () => {
                    const isCollapsed = toggleCollapseBtn.textContent.includes('Collapse');
                    document.querySelectorAll('.widget').forEach(w => {
                        if (isCollapsed) {
                            w.classList.add('minimized');
                        } else {
                            w.classList.remove('minimized');
                        }
                    });
                    toggleCollapseBtn.textContent = isCollapsed ? 'Expand All Widgets' : 'Collapse All Widgets';
                    saveWidgetPositions();
                    hideContextMenu();
                });

                toggleBgBtn.addEventListener('click', () => {
                    document.body.classList.toggle('bg-hidden');
                    localStorage.setItem(BACKGROUND_HIDDEN_KEY, document.body.classList.contains('bg-hidden'));
                    hideContextMenu();
                });

                showSettingsBtn.addEventListener('click', () => {
                    const settingsWidget = document.getElementById('settings-widget');
                    if (!settingsWidget) {
                        initSettingsWidget();
                    } else {
                        // If it exists but was minimized, un-minimize it
                        settingsWidget.classList.remove('minimized');
                        settingsWidget.style.zIndex = ++highestZ;
                    }
                    hideContextMenu();
                });
            }

            function initSettingsWidget() {
                const icon = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-purple-300"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>`;
                const { widget, content, header } = createWidget('settings-widget', icon, 'Settings', ['w-96']);
                
                const currentBg = localStorage.getItem(BACKGROUND_URL_KEY) || 'https://images.pexels.com/photos/1025469/pexels-photo-1025469.jpeg';

                content.innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <label for="bg-url-input" class="block text-sm font-medium text-gray-300 mb-1">Background Image URL</label>
                            <input type="text" id="bg-url-input" class="w-full bg-white/10 text-white rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-purple-400" value="${currentBg}">
                        </div>
                        <div class="flex justify-end">
                            <button id="save-bg-btn" class="px-4 py-2 bg-purple-500 rounded-md hover:bg-purple-600">Save</button>
                        </div>
                    </div>
                `;
                
                const closeButton = document.createElement('button');
                closeButton.className = 'close-widget-btn text-gray-400 hover:text-white ml-2';
                closeButton.innerHTML = `&#x2715;`; // 'X' symbol
                closeButton.onclick = (e) => {
                    e.stopPropagation();
                    widget.remove(); // This will close/hide the widget by removing it
                };
                header.appendChild(closeButton);

                document.getElementById('dashboard-container').appendChild(widget);
				
				// Center the widget on the screen
                const widgetWidth = widget.offsetWidth;
                const widgetHeight = widget.offsetHeight;
                const screenWidth = window.innerWidth;
                const screenHeight = window.innerHeight;

                widget.style.left = `${(screenWidth - widgetWidth) / 2}px`;
                widget.style.top = `${(screenHeight - widgetHeight) / 2}px`;
				
                applyCoreWidgetFunctionality(widget);

                const saveBtn = content.querySelector('#save-bg-btn');
                const input = content.querySelector('#bg-url-input');

                saveBtn.addEventListener('click', () => {
                    const newUrl = input.value.trim();
                    if (newUrl) {
                        document.body.style.backgroundImage = `url('${newUrl}')`;
                        localStorage.setItem(BACKGROUND_URL_KEY, newUrl);
                    }
                });

                return widget;
            }
			
			async function defaultWidgets() {
				await initDefaultWidgets();
			}
			
			async function initThirdPartyWidgets() {
				// container
				await initPetGame();
			}

            // --- MAIN EXECUTION ---
            async function main() {
                // Apply saved settings first
                applySavedSettings();

                // Create all default widgets
                await defaultWidgets();
				
				// 3rd party widgets
				await initThirdPartyWidgets();

                // Apply core functionality to all of them
                document.querySelectorAll('.widget').forEach(applyCoreWidgetFunctionality);

                // Initialize the context menu
                initContextMenu();

                // Finally, load their positions from storage, or apply default
                loadWidgetPositions();
            }

            main();
        });
    </script>
</body>
</html>
